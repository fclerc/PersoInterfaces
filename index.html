<!DOCTYPE HTML>

<html>
    <head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <link href="css/bootstrap.css" type="text/css" rel="stylesheet"/>
        <link href="XMLDisplay.css" type="text/css" rel="stylesheet"/>
        <link href="RulesInterface.css" type="text/css" rel="stylesheet"/>
        
        <style>
        
        </style>
    </head>
    
    <body>
	<div id="ProfileAndContext" class="mains">
		<h2>Selection of indicators</h2>
		<ul class="nav nav-tabs">
			<li class="active"><a href="#Profile" data-toggle="tab">Profile</a></li>
			<li><a href="#Context" data-toggle="tab">Context</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active" id="Profile"></div>
			<div class="tab-pane" id="Context"></div>
		</div>
	
	</div>
	
		<div id="Rules" class="mains">
			<h2>Definition of pedagogical strategy</h2>
			<div id="newRuleContainer"></div>
			<div id="newRuleInstruction"></div>
			<div id="newRuleForm"></div>
			<button id="ruleAdder" class = "btn btn-info"><span class="glyphicon glyphicon-plus"></span> Add new Rule</button>
			<button id="ruleSaver" class = "btn btn-success"><span class="glyphicon glyphicon-floppy-disk"></span> Save my strategy</button>
		</div>
		<div id="Activities" class="mains">
			<h2>Selection of the activities</h2>
		</div>
		
        <script type="text/javascript" src="jquery-2.1.1.js"></script>
        <script type="text/javascript" src="js/bootstrap.js"></script>
        
        <script type="text/javascript" src="xmlManipulator.js"></script>
        <script type="text/javascript">
        
            $(function(){
                $.ajax({
					type: "GET",
					url: 'foveaStrategy.xml',
					success: function(data){//get the xml document
						var strategy = $(data);//load xml tree
						
						//loading the content of the other xml docs
						var profileFilename = $($(strategy).find('exploitedProfile')[0]).text();
						var contextFilename = $($(strategy).find('exploitedContext')[0]).text();
						var pedagogicalPropertiesFilename = $($(strategy).find('pedagogicalProperties')[0]).text();
						manipulateXML(profileFilename,'#Profile', 'select', "#Rules");
						manipulateXML(contextFilename,'#Context', 'select', '#Rules');	
						
						//the element which triggers events to treat them when an element is clicked.
						var reader = $('#Rules');
						
						//this object will be used as a dictionnary to make a list of parameters corresponding to their IDs, like 'P012' : 'Length' .
						var parametersDictionnary= new Object;
								
								
						
						
						
						$.ajax({
							type: "GET",
							url: pedagogicalPropertiesFilename,
							success: function(data){
								var xml = new Array;
								xml['#Activities']=$(data);//load xml tree
								
								
								
								//the element that will contain all the activities
								var activitiesContainer = $('<ul>').addClass('activities');
								
								//going through the activities a first time, to find the 'All' one and expand all the other parameters list with its parameters.
								var allActivityParameters = new Array;
								$(xml['#Activities']).find('TypeOfActivity').each(function(){
									var activity = this;
									var activityName = $($(activity).children('Name')[0]).text();
							
									if(activityName == 'All'){
										$(activity).find('Parameter').each(function(){
											allActivityParameters.push(this);
										});
									}
								});
								
								
								//going through activities to display them and their parameters as lists.
								$(xml['#Activities']).find('TypeOfActivity').each(function(){
									$(activitiesContainer).append(displayActivity(this, allActivityParameters));
								});
								
								
								$('#Activities').append(activitiesContainer);
								
								//setting events when clicking on activities and parameters
								
								//event when clicking on activity names. Msg is 'activity', id, '#Activities' 
								$('#Activities .activity > span').click(function(event){
								
									var activityId = $(event.target).attr('id');
									$(reader).trigger("leafValueReading",  ['activity', activityId, '#Activities']);
								});
								//event when clicking on parameters names. Msg is 'parameter', id, '#Activities' 
								$('#Activities .parameters li').click(function(event){
									var parameterId = $(event.target).attr('id');
									$(reader).trigger("leafValueReading",  ['parameter', parameterId, '#Activities']);
								});
								
								
								//displaying the rules in the center part of the page.
								//placed here in the code : the parametersDictionnary is defined just above and ready to be used.
								$(strategy).find("rule").each(function(){
									displayRule(this, '#newRuleContainer');
								});
								
								
							},
							cache: false
						});
						
						
						
						
						
						/*
						Takes an xml element containing the activity, and the list of parameters contained in the 'All' activity.
						Returns the html.
						
						
						*/
						function displayActivity(activity, allActivityParameters){
							var activityName = $($(activity).children('Name')[0]).text();
							var activityId = $(activity).attr('ID');
							if(activityName != 'All'){//the 'All' activity is only used to factorize parameters that apply to all activities, and is therefore not displayed
								//displaying the parameters of the activity, including the parameters contained in the 'All' activity
								var activityContainer=$('<li>').addClass('activity').append($('<span>').append(activityName).attr('id', activityId));
								
								var parametersContainer =$('<ul>').addClass('parameters');
								
								$(allActivityParameters).each(function(){
									addParameterToList(this, parametersContainer);								
								});
								$(activity).find('Parameter').each(function(){
									addParameterToList(this, parametersContainer);
								});
								
								$(activityContainer).append(parametersContainer);
								return activityContainer;
							}
							
							else{								
								return '';
							}
						}
						
						/*
						Takes a parameter xml element, with the div which will have to contain it.
						Appends the container with html.
						
						*/
						function addParameterToList(parameter, container){
							var parameterName = $($(parameter).children('Name')[0]).text();
							var parameterId = $(parameter).attr('ID');
							var parameterComment = $($(parameter).children('Comment')[0]).text();//TODO : use it and use scales
							var parameterContainer = $('<li>').append(parameterName).attr('id', parameterId);
							$(container).append(parameterContainer);
							
							if(!parametersDictionnary.hasOwnProperty(parameterId)){
								parametersDictionnary[parameterId] = parameterName;
							}
						}
						
						
						
						
						
						
						
						function getParameterId(parameterName){
							$.each(parametersDictionnary, function(id, value){
								if(value==parameterName){
									return id;
								}
							});
						}
						
						
						
						
						
						
						
						/*
						
						
						
						
						Rules Section
						
						*/
						
						
						
						
						
						
						
						
						/*
							Argument is a xml node containing a rule .
							This function displays the rule just before the second argument insBefore
						
						*/
						function displayRule(rule, insBefore){
							var ruleContainer = $('<div>').attr('id', $(rule).attr('id')).addClass('ruleContainer').append($('<h3>').append('Rule' + $(rule).attr('id')).append($('<span>').addClass('glyphicon glyphicon-remove-circle pull-right')));
							
							var ifContainer = $('<div>').addClass('ifContainer').append('IF');
							var ifElement = $(rule).find("if")[0];
							var indicator = $($(ifElement).find("indicator")[0]).text();
							var operator = $($(ifElement).find("operator")[0]).text();
							var referenceValue = $($(ifElement).find("referencevalue")[0]).text();
							var indicatorContainer = $('<span>').addClass('indicator').append(' '+indicator);
							var operatorContainer = $('<span>').addClass('operator').append(' '+operator);
							var referenceValueContainer = $('<span>').addClass('referenceValue').append(' '+referenceValue);
							$(ifContainer).append(indicatorContainer)
							$(ifContainer).append(operatorContainer)
							$(ifContainer).append(referenceValueContainer)
							
							//from one of the 2 tags containing the activities (<then> or <else>), returns the activities contained in it, displayed with their parameters
							function getConsequencesContainer(consequencesElement, containerName){
							
								var consequenceContainer = $('<div>').addClass(containerName).append($('<span>').append(containerName.toUpperCase()+' the learner will do the following activities: '));
								var activitiesContainer = $('<ul>');
								$(consequencesElement).find('activity').each(function(){
									var activityContainer = $('<li>').addClass('activityContainer');
									var typeOfActivity = $($(this).find("typeofactivity")[0]).text();
									var typeOfActivityContainer = $('<span>').addClass('typeOfActivity').append(' '+typeOfActivity + ', with parameters: ');
									
									var parametersContainer =$('<ul>').addClass('parameters');
									$(consequencesElement).find('parameter').each(function(){
										var paramId = $($(this).find('id')[0]).text();
										var paramValue = $($(this).find('value')[0]).text();
										var parameterContainer = $('<li>').append(parametersDictionnary[paramId]+': ' + paramValue);
										//TODO : use parameter dictionnary
										$(parametersContainer).append(parameterContainer);
									});
									$(activityContainer).append(typeOfActivityContainer);
									$(activityContainer).append(parametersContainer);
									$(activitiesContainer).append(activityContainer);
								})
								
								return $(consequenceContainer.append(activitiesContainer));
								
							}
							var thenContainer = getConsequencesContainer($(rule).find('then')[0], 'then');
							var elseContainer = getConsequencesContainer($(rule).find('else')[0], 'else');
							
							$(ruleContainer).append(ifContainer);
							$(ruleContainer).append(thenContainer);
							$(ruleContainer).append(elseContainer);
							$(ruleContainer).insertBefore($(insBefore));
						
						}
						
						
						//responding to user definition of rules
						/*
						1: Selection of indicator
						2: Selection of operator
						3: referenceValue is given
						4: Selection of activity for then
						5: Selection of parameter for then
						6: value of parameter is given for then
						7: Selection of activity for else
						8: Selection of parameter for else
						9: value of parameter is given for else
						
						
						At each time : change the xml tree, and make a new call on the displayer.
						
						*/
						var currentOperation = 0;
						var instructions = ['Click on new rule', 'Choose the indicator you want to base your rule on from the profile or the context', 'Choose the operator you want to use in this rule in the form below', 'Give the value used for the comparison', 'Select the activity for the then part of the rule', 'Select a parameter you want to set for this activity', 'Give the value for the parameter', 'Select the activity for the else part of the rule', 'Select a parameter you want to set for this activity', 'Give the value for the parameter']
						
						//used in last operations, to know whether we are in the definition of <then> or <else>
						var operationToConsequence = ['', '', '', '', 'then','then','then','else','else','else'];
						
						var builtRule = new Object;
						
						var lastParameter;//used in stages when asking parameter value to the user, to add this parameter the <value>
						
						$("#Rules").on("leafValueReading", function(event, value, id, container){
							
							if(currentOperation ==1){//user gives an indicator, other things are just ignored
							
								if(container == "#Profile"){
									$(builtRule).append($('<if>').append($('<indicator>').text(id)));
									
									var operatorSelect = $('<select>');
									var operators = ['=', '>', '<', '!='];
									$(operators).each(function(id, op){
										$(operatorSelect).append($('<option>').append(op));
									});
									$('#newRuleForm').append(operatorSelect).append($('<span>').addClass('glyphicon glyphicon-ok-sign'));
									
									$('#newRuleForm .glyphicon-ok-sign').unbind('click').click(function(){
										var op = $('#newRuleForm select').val();
										$(reader).trigger("leafValueReading",  [op, 0, '#newRuleForm']);									
									});
									
									currentOperation = 2;
								}
							}
							
							else if(currentOperation ==2){//received event contains the operator
								if(container=='#newRuleForm'){
									var op = $('<operator>').text(value);
									op.insertAfter($($(builtRule).find('indicator')[0]))
									
									displayValueInput();
									
									currentOperation = 3;
								}
							}
							
							else if(currentOperation == 3){//event contains the value to compare the indicator with
								if(container=='#newRuleForm'){
									var refVal = $('<referencevalue>').text(value);
									refVal.insertAfter($($(builtRule).find('operator')[0]))
									
									removeForms();
									
									currentOperation = 4;
								}
							
							
							
							}
							
							else if(currentOperation == 4 || currentOperation == 7){//an activity has been clicked on (either for then or else parts)
								if(container=='#Activities' && value == 'activity'){
									$(builtRule).append($('<'+operationToConsequence[currentOperation]+'>').append($('<activities>').append($('<activity>').append($('<typeofactivity>').append(id)).append($('<parameters>')))));
									currentOperation++;
								}
							}
							
							else if(currentOperation == 5 ||currentOperation==8){//a parameter has been clicked on
								if(container=='#Activities' && value == 'parameter'){
									var activity = $($(builtRule).find(operationToConsequence[currentOperation])[0]).find('activity').last();
									
									var parameter = $('<parameter>').append($('<id>').text(id));
									
									$($(activity).find('parameters')[0]).append(parameter);
									displayValueInput();
									lastParameter = parameter;
									currentOperation++;
								}
							}
							
							else if(currentOperation == 6 || currentOperation == 9){
								
								if(container == '#newRuleForm'){
									$(lastParameter).append($('<value>').append(value));
									removeForms();
									currentOperation++;
									if(currentOperation == 10){
										currentOperation = 0;
										$($(strategy).find('strategyRules')[0]).append(builtRule);
										displayRule(builtRule, '#newRuleContainer');
										$('#newRuleContainer').empty();
										$('#newRuleInstruction').text('Success, your rule has been created! You can create another one if you want');
										
									}
								}
							}
							//displaying the currently built rule
							if(currentOperation != 0){
								$('#newRuleContainer').text('');//empty the container
								$('#newRuleContainer').append($('<div>').attr('id', 'emptyDiv'));//adding empty div to pass it as insBeofre argument in displayRule function
								(displayRule(builtRule[0], '#emptyDiv'));//displaying the in-process rule
								$('#newRuleInstruction').text(instructions[currentOperation]);//giving next instruction to the user
							}
							
							
							
							
							//displays the value input together with a button to click on
							function displayValueInput(){							
								var valueInput = $('<input>').attr('type', 'text');
								removeForms();
								
								$('#newRuleForm').append(valueInput);
								$('#newRuleForm').append($('<span>').addClass('glyphicon glyphicon-ok-sign'));
								
								$('#newRuleForm .glyphicon-ok-sign').unbind('click').click(function(){
									var val = $('#newRuleForm input').val();
									$(reader).trigger("leafValueReading",  [val, 0, '#newRuleForm']);									
								});
							}
							
							//removes all forms in the rules part.
							function removeForms(){
								$('#newRuleForm select').remove();
								$('#newRuleForm .glyphicon').remove();
								$('#newRuleForm input').remove();
							}
							
						
						});
						
						$('#ruleAdder').click(function(){
							if(currentOperation == 0){
								currentOperation = 1;
								builtRule = $('<rule>');
								$('#newRuleInstruction').text(instructions[currentOperation]);
							}
						});
						
						$('#ruleSaver').click(function(){
							var xmlS = (new XMLSerializer()).serializeToString(strategy[0]);
							$.post('saveXMLDocument.php', { file: 'foveaStrategy.xml' , data: xmlS}, 
								function(data, txt, jqXHR){
									if(txt=="success"){
										alert('Your data have been successfully saved');
									}
								}
							);
						
						});

						
						
						
						
						
						//function used to keep the colons always visible when scrolling
						function alwaysVisible(elementId){
							var initialTop = $(elementId).offset().top;
						
							$(document).scroll(function(){
								var bottomWindowPosition = $(document).scrollTop() + $(window).height();
								
								if(bottomWindowPosition < $(document).height()){
									
									if($(elementId).height() < bottomWindowPosition){
										if($(elementId).height() > $(window).height()){
											$(elementId).css('margin-top',initialTop + bottomWindowPosition - $(elementId).height());
										}
										else{
											$(elementId).css('margin-top',initialTop + $(document).scrollTop());
										}
										
									}
									else{
										$(elementId).css('margin-top',initialTop);
									}
								}
							});
						}
						alwaysVisible('#Rules');
						alwaysVisible('#Activities');
						alwaysVisible('#ProfileAndContext');
						
						
					},
					cache: false
                });
            
            });
            
            
        </script>
    </body>


</html>
